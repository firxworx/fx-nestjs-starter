# fx-nestjs-starter

This project is an opinionated basic starter or "boilerplate" for API's implemented with NestJS. The code builds on the boilerplate generated by the nestjs cli and includes additional configuration and features that are common to many projects.

The purpose of this project is to help developers to save time when starting new projects.

The nestjs configuration is thoroughly documented with descriptive comments to support usage in a professional team or consulting environment. The comments provide guidance for developers who may not be familiar with nestjs, typeorm, or other libraries in play and serve as an _aide-m√©moire_ for those already familiar with nestjs.

NestJS is powered by Express vs. Fastify so projects can leverage of the vast ecosystem of Express middleware.

App Features:

- improved `tsconfig.json` that includes `strict: true` to realize the full benefit of TypeScript
- configuration via idomatic @nestjs/config (refer to `src/config`)
- global database module powered by TypeORM + postgres, featuring a TypeScript-based `ormconfig` file
- auth + users modules with local and JWT strategies + http-only cookie authentication powered by passport
- aws module with aws-ses service for sending emails via AWS SES (uses @aws-sdk v3)
- swagger/openapi configuration
- logging via nestjs-pino (pino), which provides an idiomatic nestjs logger that supports json output

Development + DevOps Features:

- Dockerized with a `Dockerfile` and `docker-compose.yml` file

## Using this starter

Two ways you can use this starter are:

- create a new project with the nestjs cli and cherry-pick configuration code and modules as required, or
- fork this repo or download the source code from github and use it as the basis for your new project.

If you choose to fork/copy/download this repo:

Revise the `name`, `description`, `version`, `author`, `license`, etc. in `package.json` to suit your project.

Replace or delete the `LICENSE` file to suit your project.

Search the repo for the `@starter` tag (e.g. run `grep -r "@starter" src/` from the project root folder) to pull up comments that identify consideration/review/decision points that you may want to customize in any project that's based off this starter.

In case the package versions in `package.json` are out of date, it is recommended that you upgrade them prior to commencing significant development on your project (e.g. `yarn upgrade-interactive --latest`). Note that you may need to update the code to support major version upgrades from any packages.

For documentation refer to:

- NestJS: <https://docs.nestjs.com/>
- TypeORM: <https://github.com/typeorm/typeorm/tree/master/docs>

### Removing TypeORM + Postgres

This starter includes TypeORM + Postgres because this is a common combination in many nestjs projects. If your project does not require a database or if you would like to use a different database/configuration/ORM then it is easily removed:

If you do not require typeorm:

- Remove package dependencies: `yarn remove @nestjs/typeorm typeorm typeorm-seeding`
- Revise `package.json`: delete `typeorm` and `migration`-related entries from `scripts`

If you do not require postgres:

- Remove package dependencies: `yarn remove pg pg-protocol`
- Revise `docker-compose.yml`: comment out or delete the `postgres` service and remove it from the `api` service's `depends_on` list

In all cases:

- As applicable to your project, either remove `DatabaseModule` from the `imports` array in `src/modules/app/app.module.ts`, or revise the module as required to suit the needs of your project.

## Development

Clone or fork this project then install package dependencies via:

```bash
yarn
```

Create a new local `.env` file based on the example `.env.sample` file.

If you do not already have a postgres database running and wish to start postgres (docker), run:

```bash
yarn docker:postgres:up
```

To setup the database:

```bash
yarn migration:run

yarn seed:run

yarn start:dev
```

## TypeORM

@todo - revised package.json so name is required to be added - either revert + test or document here

The TypeORM configuration file for this project is: `src/ormconfig.ts`.

The conventions are:

- entity filename extension: `*.entity.ts`
- subscriber filename extension: `*.subscriber.ts`


TypeORM will pick up `ormconfig.{json,js,ts}` in a project's root folder however placing it there can.

TYPEORM_CONNECTION (corresponds to the `type` property in an `ormconfig` file),
TYPEORM_HOST,
TYPEORM_PORT,
TYPEORM_USERNAME,
TYPEORM_PASSWORD,
TYPEORM_DATABASE,

```ts
    "typeorm": "ts-node -r tsconfig-paths/register node_modules/typeorm/cli.js --config src/ormconfig.ts",
    "migration:generate": "yarn run typeorm migration:generate -n",
    "migration:create": "yarn run typeorm migration:create -n",
    "migration:run": "yarn run typeorm migration:run",
    "migration:revert": "yarn run typeorm migration:revert",
```


### Generating migrations

After adding or revising entity classes, run the following command to generate migrations to update the database schema:

```sh
# replace "MigrationName" with a short and descriptive name for the migration (e.g. "UserTable")
yarn migration:generate MigrationName
```

The generated file will be added to `src/modules/database/migrations` per the config in `src/ormconfig.ts`.

### Creating migrations

To create a new empty migration with boilerplate/scaffold code, run:

```sh
# replace "MigrationName" with a short and descriptive name for the migration
yarn migration:create MigrationName
```

The newly created migration will contain `up()` and `down()` methods awaiting your implementation. TypeORM calls `up()` to perform the migration and `down()` to revert it. Each method is passed an instance of `QueryRunner` that can then be used to build migration queries by hand, or you can use the migration API.

For example: 

```ts
await queryRunner.query(`ALTER TABLE "user" RENAME "name" to "fullName"`);
```

### Running migrations

To run migrations via the cli:

```sh
yarn migration:run
```

To run migrations in code, call the `runMigrations()` method on an instance of the typeorm Connection class (which reflects a connection to the database) in an async method:

```sh
await connection.runMigrations()
```

Also refer to the `migrationsRun` property in `src/ormconfig.ts`. When set to `true`, typeorm will automatically run migrations when the app is started and establishes a connection to the database.

### Reverting migrations

To revert migrations:

```sh
yarn migration:revert
```

## OpenAPI/Swagger

OpenAPI/Swagger can be conditionally enabled by setting the `OPENAPI_ENABLED_FLAG` environment variable to `1`. It is read in by `config/app.config.ts` and used in `src/main.ts`.

If enabled, the Swagger UI is available at the URL path: `/api` (the path does not include the global prefix).

Note that the Swagger UI + Swagger Editor does not currently support cookie authentication: <https://github.com/swagger-api/swagger-js/issues/1163>

The opt-in nestjs cli plugin packaged with `@nestjs/swagger` is enabled for this project in `nest-cli.json`.

The plugin automatically adds OpenAPI/Swagger decorators to DTO's and entities, and it can pull values from `class-validator` decorators. It greatly reduces the maintenance burden and overall redundancy involved separately defining properties for both nestjs functionality and OpenAPI/Swagger.

Among the various features and behaviours of this plugin: it will automatically annotate all DTO + entity fields with `@ApiProperty` unless they are decorated with `@ApiHideProperty`.

The plugin adheres to nestjs conventions and only analyzes files with the following extensions: `.dto.ts` and `.entity.ts`.

Refer to the docs for more on the plugin, available decorators, and its configuration options: <https://docs.nestjs.com/openapi/cli-plugin>.


## Running the app

```bash
# development
yarn start

# development (watch mode)
yarn start:dev

# debug (watch mode)
yarn start:debug

# production
yarn start:prod
```

## Testing

```bash
# run unit tests
yarn test

# run e2e tests
yarn test:e2e

# compute test coverage
yarn test:cov
```

## License

Original code in the `fx-nestjs-starter` project is released under the Apache 2.0 license by author Kevin Firko (`@firxworx`).
